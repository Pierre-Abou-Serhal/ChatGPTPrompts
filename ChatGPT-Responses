ALTER PROCEDURE [dbo].[usp_GetAccountInfo_By_AltaccountId_List]
(
    @P__AltaccountId_List NVARCHAR(MAX)
)
AS
BEGIN
    SET NOCOUNT ON;

    -- 1. Split the CSV string into a table variable (using STRING_SPLIT)
    DECLARE @Tokens TABLE (Token NVARCHAR(200));
    INSERT INTO @Tokens(Token)
    SELECT TRIM(value)
    FROM STRING_SPLIT(@P__AltaccountId_List, ',');

    -- 2. Build a combined full-text search condition
    DECLARE @SearchCondition NVARCHAR(MAX);
    SELECT @SearchCondition = STRING_AGG('"' + REPLACE(Token, '"', '""') + '"', ' OR ')
    FROM @Tokens;

    -- 3. Retrieve candidate rows using the combined full-text search
    SELECT 
        a.[Id] AS T24AccountId,
        arr.Product,
        a.ArrangementId,
        arr.ProdEffDate,
        a.AltAcctIdSpaces
    INTO #Candidate
    FROM t_AccountV2 a
    JOIN t_Arrangement_T24 arr
      ON arr.Id = a.ArrangementId
    WHERE a.[Id] LIKE '01%' 
      AND LEN(a.[Id]) = 15 
      AND arr.ProductStatus = 'CURRENT'
      AND CONTAINS(a.AltAcctIdSpaces, @SearchCondition);

    -- 4. Join the candidate rows with tokens using CHARINDEX to identify actual matches
    SELECT 
        t.Token AS InputedId,
        c.T24AccountId,
        c.Product,
        c.ArrangementId,
        c.ProdEffDate
    INTO #Results
    FROM #Candidate c
    JOIN @Tokens t
      ON CHARINDEX(t.Token, c.AltAcctIdSpaces) > 0;

    -- 5. Deduplicate: for each (InputedId, T24AccountId), keep the row with the latest ProdEffDate
    ;WITH CTE AS
    (
        SELECT
            r.InputedId,
            r.T24AccountId,
            r.Product,
            r.ArrangementId,
            r.ProdEffDate,
            ROW_NUMBER() OVER (
                PARTITION BY r.InputedId, r.T24AccountId
                ORDER BY r.ProdEffDate DESC
            ) AS rn
        FROM #Results r
    )
    SELECT
        InputedId,
        T24AccountId,
        Product AS ProductCode
    FROM CTE
    WHERE rn = 1
    ORDER BY T24AccountId, InputedId;

    SET NOCOUNT OFF;
END
