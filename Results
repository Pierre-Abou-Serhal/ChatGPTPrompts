CREATE OR ALTER PROCEDURE dbo.usp_Alterna_GetDuplicateCustomers
(
  @MaxCandidatesPerNew int = 500,
  @StatusCode NVARCHAR(250) = N'PENDING',
  @DifferenceThreshold tinyint = 1  -- 1 -- Can have a value between 1 and 4 the higher, the stricter
)
AS
BEGIN
  SET NOCOUNT ON;

  ;WITH NC AS
  (
    SELECT
		T24C.Id AS NewCustomerId,
		dbo.Fn_NormalizeWord(T24C.DateOfBirth) AS DateOfBirth,
		dbo.Fn_NormalizeWord(T24C.GivenNames) AS GivenNames,
		dbo.Fn_NormalizeWord(T24C.FamilyName) AS FamilyName,
		dbo.Fn_NormalizeWord(T24C.FatherName) AS FatherName,
		dbo.Fn_NormalizeWord(T24C.MoFirstName) AS MoFirstName,
		dbo.Fn_NormalizeWord(T24C.BirthRegister) AS BirthRegister,
		dbo.Fn_NormalizeWord(T24C.BirthRegNo) AS BirthRegNo,
		dbo.Fn_NormalizeWord(T24C.Gender) AS Gender
    FROM dbo.t_NewT24Customers AS NT24C
		JOIN dbo.t_T24Customer AS T24C ON NT24C.CustomerId = T24C.Id
    WHERE NT24C.StatusCode = @StatusCode
  )
  SELECT
    nc.NewCustomerId,
    c.CustomerId,

    -- New customer values
    nc.DateOfBirth   AS New_DateOfBirth,
    nc.GivenNames    AS New_GivenNames,
    nc.FamilyName    AS New_FamilyName,
    nc.FatherName    AS New_FatherName,
    nc.MoFirstName   AS New_MoFirstName,
    nc.BirthRegister AS New_BirthRegister,
    nc.BirthRegNo    AS New_BirthRegNo,
    nc.Gender        AS New_Gender,

    -- Candidate values
    c.Db_DateOfBirth,
    c.Db_GivenNames,
    c.Db_FamilyName,
    c.Db_FatherName,
    c.Db_MoFirstName,
    c.Db_BirthRegister,
    c.Db_BirthRegNo,
    c.Db_Gender,

    -- Exact flags
    c.Match_DateOfBirth,
    c.Match_BirthRegNo,
    c.Match_BirthRegister,
    c.Match_Gender,

    -- Fuzzy flags
    c.Match_GivenNames,
    c.Match_FamilyName,
    c.Match_FatherName,
    c.Match_MoFirstName
  FROM NC AS nc
CROSS APPLY
(
    SELECT TOP (@MaxCandidatesPerNew)
        t.Id AS CustomerId,

        dbo.Fn_NormalizeWord(t.DateOfBirth)   AS Db_DateOfBirth,
        dbo.Fn_NormalizeWord(t.GivenNames)    AS Db_GivenNames,
        dbo.Fn_NormalizeWord(t.FamilyName)    AS Db_FamilyName,
        dbo.Fn_NormalizeWord(t.FatherName)    AS Db_FatherName,
        dbo.Fn_NormalizeWord(t.MoFirstName)   AS Db_MoFirstName,
        dbo.Fn_NormalizeWord(t.BirthRegister) AS Db_BirthRegister,
        dbo.Fn_NormalizeWord(t.BirthRegNo)    AS Db_BirthRegNo,
        dbo.Fn_NormalizeWord(t.Gender)        AS Db_Gender,

        -- Exact match flags
        CAST(CASE WHEN dbo.Fn_NormalizeWord(t.DateOfBirth)   = nc.DateOfBirth   THEN 1 ELSE 0 END AS bit) AS Match_DateOfBirth,
        CAST(CASE WHEN dbo.Fn_NormalizeWord(t.BirthRegNo)    = nc.BirthRegNo    THEN 1 ELSE 0 END AS bit) AS Match_BirthRegNo,
        CAST(CASE WHEN dbo.Fn_NormalizeWord(t.BirthRegister) = nc.BirthRegister THEN 1 ELSE 0 END AS bit) AS Match_BirthRegister,
        CAST(CASE WHEN dbo.Fn_NormalizeWord(t.Gender)        = nc.Gender        THEN 1 ELSE 0 END AS bit) AS Match_Gender,

        -- Fuzzy flags
        CAST(CASE WHEN t.GivenNames  IS NOT NULL
                  AND DIFFERENCE(nc.GivenNames, dbo.Fn_NormalizeWord(t.GivenNames))   >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_GivenNames,
        CAST(CASE WHEN t.FamilyName IS NOT NULL
                  AND DIFFERENCE(nc.FamilyName, dbo.Fn_NormalizeWord(t.FamilyName))   >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_FamilyName,
        CAST(CASE WHEN t.FatherName IS NOT NULL
                  AND DIFFERENCE(nc.FatherName, dbo.Fn_NormalizeWord(t.FatherName))   >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_FatherName,
        CAST(CASE WHEN t.MoFirstName IS NOT NULL
                  AND DIFFERENCE(nc.MoFirstName, dbo.Fn_NormalizeWord(t.MoFirstName)) >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_MoFirstName

    FROM dbo.t_T24Customer AS t
    WHERE
        t.Id <> nc.NewCustomerId

        AND t.GivenNames  IS NOT NULL
        AND t.FamilyName  IS NOT NULL
        AND t.FatherName  IS NOT NULL
        AND t.MoFirstName IS NOT NULL

        AND DIFFERENCE(nc.GivenNames,  dbo.Fn_NormalizeWord(t.GivenNames))  >= @DifferenceThreshold
        AND DIFFERENCE(nc.FamilyName,  dbo.Fn_NormalizeWord(t.FamilyName))  >= @DifferenceThreshold
        AND DIFFERENCE(nc.FatherName,  dbo.Fn_NormalizeWord(t.FatherName))  >= @DifferenceThreshold
        AND DIFFERENCE(nc.MoFirstName, dbo.Fn_NormalizeWord(t.MoFirstName)) >= @DifferenceThreshold

    ORDER BY t.Id
) AS c
  ORDER BY nc.NewCustomerId, c.CustomerId;
END
GO


USE [Alterna_KYC]
GO

/****** Object:  Table [dbo].[t_T24Customer]    Script Date: 12/22/2025 9:08:34 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[t_T24Customer](
	[Id] [int] NOT NULL,
	[GivenNames] [nvarchar](2000) NOT NULL,
	[FamilyName] [nvarchar](2000) NOT NULL,
	[MaritalStatus] [nvarchar](2000) NOT NULL,
	[SpFirstName] [nvarchar](2000) NOT NULL,
	[SpLastName] [nvarchar](2000) NOT NULL,
	[SgbChildren] [nvarchar](2000) NOT NULL,
	[NoOfChildren] [nvarchar](2000) NOT NULL,
	[SgbChildName] [nvarchar](2000) NOT NULL,
	[SgbDtOfBirth] [nvarchar](2000) NOT NULL,
	[SgbEducation] [nvarchar](2000) NOT NULL,
	[SgbOccupation] [nvarchar](2000) NOT NULL,
	[SgbEmployer] [nvarchar](2000) NOT NULL,
	[SpouseProf] [nvarchar](2000) NOT NULL,
	[SpofDetails] [nvarchar](2000) NOT NULL,
	[SgbSpAnlSal] [nvarchar](2000) NOT NULL,
	[Nationality] [nvarchar](2000) NOT NULL,
	[SgbHldOthNat] [nvarchar](2000) NOT NULL,
	[SgbOthrNat] [nvarchar](2000) NOT NULL,
	[SgbOthrDocNm] [nvarchar](2000) NOT NULL,
	[SgbOthrDocNr] [nvarchar](2000) NOT NULL,
	[EmploymentStatus] [nvarchar](2000) NOT NULL,
	[SgbSalaryDom] [nvarchar](2000) NOT NULL,
	[SgbClientFunc] [nvarchar](2000) NOT NULL,
	[Occupation] [nvarchar](2000) NOT NULL,
	[JobTitle] [nvarchar](2000) NOT NULL,
	[EmployersBuss] [nvarchar](2000) NOT NULL,
	[EmployersName] [nvarchar](2000) NOT NULL,
	[EmploymentStart] [nvarchar](2000) NOT NULL,
	[Salary] [nvarchar](2000) NOT NULL,
	[SalaryDateFreq] [nvarchar](2000) NOT NULL,
	[SgbFinTwnCty] [nvarchar](2000) NOT NULL,
	[SgbFinMohfaz] [nvarchar](2000) NOT NULL,
	[SgbFinCaza] [nvarchar](2000) NOT NULL,
	[SgbFinCity] [nvarchar](2000) NOT NULL,
	[SgbFinLoc] [nvarchar](2000) NOT NULL,
	[SgbFinStreet] [nvarchar](2000) NOT NULL,
	[SgbFinDistrct] [nvarchar](2000) NOT NULL,
	[SgbFinBld] [nvarchar](2000) NOT NULL,
	[SgbFinFlrNo] [nvarchar](2000) NOT NULL,
	[SgbFinAptNo] [nvarchar](2000) NOT NULL,
	[SgbFinNextTo] [nvarchar](2000) NOT NULL,
	[SgbFinPoBox] [nvarchar](2000) NOT NULL,
	[SgbFinDept] [nvarchar](2000) NOT NULL,
	[SgbFinRegion] [nvarchar](2000) NOT NULL,
	[SgbFinPstOff] [nvarchar](2000) NOT NULL,
	[SgbCrsTaxRes] [nvarchar](2000) NOT NULL,
	[SgbCrsTaxId] [nvarchar](2000) NOT NULL,
	[SgbSpouseName] [nvarchar](2000) NOT NULL,
	[SgbNoOfSrcs] [nvarchar](2000) NOT NULL,
	[SgbSrcFunds] [nvarchar](2000) NOT NULL,
	[SgbFinDets] [nvarchar](2000) NOT NULL,
	[EstWealth] [nvarchar](2000) NOT NULL,
	[SglProsCoGrp] [nvarchar](2000) NOT NULL,
	[AnlSalary] [nvarchar](2000) NOT NULL,
	[SgbEstWealth] [nvarchar](2000) NOT NULL,
	[SgbReaEsProp] [nvarchar](2000) NOT NULL,
	[SgbReaEsRegn] [nvarchar](2000) NOT NULL,
	[AnnualVolIn] [nvarchar](2000) NOT NULL,
	[AnnualVolOut] [nvarchar](2000) NOT NULL,
	[Residence] [nvarchar](2000) NOT NULL,
	[CusCity] [nvarchar](2000) NOT NULL,
	[City] [nvarchar](2000) NOT NULL,
	[CusCaza] [nvarchar](2000) NOT NULL,
	[CusMohafaza] [nvarchar](2000) NOT NULL,
	[Department] [nvarchar](2000) NOT NULL,
	[Province] [nvarchar](2000) NOT NULL,
	[Street] [nvarchar](2000) NOT NULL,
	[CustDistrict] [nvarchar](2000) NOT NULL,
	[CusBuilding] [nvarchar](2000) NOT NULL,
	[FloorNo] [nvarchar](2000) NOT NULL,
	[ApartmentNo] [nvarchar](2000) NOT NULL,
	[NextTo] [nvarchar](2000) NOT NULL,
	[PoBox] [nvarchar](2000) NOT NULL,
	[CusRegion] [nvarchar](2000) NOT NULL,
	[PCntryCode] [nvarchar](2000) NOT NULL,
	[MCntryCode] [nvarchar](2000) NOT NULL,
	[LastKycReviewDate] [nvarchar](2000) NOT NULL,
	[SgbRbaClassif] [nvarchar](2000) NOT NULL,
	[AutoNextKycReviewDate] [nvarchar](2000) NOT NULL,
	[ManualNextKycReviewDate] [nvarchar](2000) NOT NULL,
	[Title] [nvarchar](2000) NOT NULL,
	[ArFirstName] [nvarchar](2000) NOT NULL,
	[ArLastName] [nvarchar](2000) NOT NULL,
	[ArFFirstName] [nvarchar](2000) NOT NULL,
	[ArMoLName] [nvarchar](2000) NOT NULL,
	[ArMoFName] [nvarchar](2000) NOT NULL,
	[FatherName] [nvarchar](2000) NOT NULL,
	[MoFirstName] [nvarchar](2000) NOT NULL,
	[MoLastName] [nvarchar](2000) NOT NULL,
	[Target] [nvarchar](2000) NOT NULL,
	[Industry] [nvarchar](2000) NOT NULL,
	[AccountOfficer] [nvarchar](2000) NOT NULL,
	[DateOfBirth] [nvarchar](2000) NOT NULL,
	[Gender] [nvarchar](2000) NOT NULL,
	[SgbCnEcSectr] [nvarchar](2000) NOT NULL,
	[CustomerStatus] [nvarchar](2000) NOT NULL,
	[BirthRegister] [nvarchar](2000) NOT NULL,
	[LegalId] [nvarchar](2000) NOT NULL,
	[LegalDocName] [nvarchar](2000) NOT NULL,
	[LegalIssDate] [nvarchar](2000) NOT NULL,
	[MainAdd] [nvarchar](2000) NOT NULL,
	[MailAddress] [nvarchar](2000) NOT NULL,
	[PhoneNo] [nvarchar](2000) NOT NULL,
	[PhoneAreaCode] [nvarchar](2000) NOT NULL,
	[ProfDetails] [nvarchar](2000) NOT NULL,
	[KycUpToDate] [nvarchar](2000) NOT NULL,
	[SgbHouseHead] [nvarchar](2000) NOT NULL,
	[SglArabicName] [nvarchar](2000) NOT NULL,
	[SgbEstablmnt] [nvarchar](2000) NOT NULL,
	[SgbEduLevel] [nvarchar](2000) NOT NULL,
	[SgbBnRgtOwnr] [nvarchar](2000) NOT NULL,
	[SgbOpFrCntry] [nvarchar](2000) NOT NULL,
	[SgbAcOpnCnxt] [nvarchar](2000) NOT NULL,
	[SgbPep] [nvarchar](2000) NOT NULL,
	[SgbAcctType] [nvarchar](2000) NOT NULL,
	[SgbMotAcOpen] [nvarchar](2000) NOT NULL,
	[SgbAcOpnAbrd] [nvarchar](2000) NOT NULL,
	[SgbAcNonResi] [nvarchar](2000) NOT NULL,
	[SgbCusAflGrp] [nvarchar](2000) NOT NULL,
	[SgbMnlIndicia] [nvarchar](2000) NOT NULL,
	[SgbPlDelivery] [nvarchar](2000) NOT NULL,
	[SgbCrsTestDt] [nvarchar](2000) NOT NULL,
	[SgbCrsIndSt] [nvarchar](2000) NOT NULL,
	[SgbCrsCoc] [nvarchar](2000) NOT NULL,
	[SgbCrsStDate] [nvarchar](2000) NOT NULL,
	[SgbCrsDoc] [nvarchar](2000) NOT NULL,
	[SgbCrsTestRt] [nvarchar](2000) NOT NULL,
	[SgbTransOrder] [nvarchar](2000) NOT NULL,
	[SgbBirthCnt] [nvarchar](2000) NOT NULL,
	[OthFinRel] [nvarchar](2000) NOT NULL,
	[OtFinInst] [nvarchar](2000) NOT NULL,
	[ResidenceStatus] [nvarchar](2000) NOT NULL,
	[ResidenceType] [nvarchar](2000) NOT NULL,
	[ResidenceSince] [nvarchar](2000) NOT NULL,
	[SgbJobPrev] [nvarchar](2000) NOT NULL,
	[SgbCrsTaxDt] [nvarchar](2000) NOT NULL,
	[SgbCrsCancel] [nvarchar](2000) NOT NULL,
	[SgbCrsCancDt] [nvarchar](2000) NOT NULL,
	[SgbCrsSource] [nvarchar](2000) NOT NULL,
	[SgbClosureRef] [nvarchar](2000) NOT NULL,
	[SgbKycNewewal] [nvarchar](2000) NOT NULL,
	[SgbPepTitle] [nvarchar](2000) NOT NULL,
	[CompanyBook] [nvarchar](2000) NOT NULL,
	[SgbDtRevRmi] [nvarchar](2000) NOT NULL,
	[LbmbAreaCode] [nvarchar](2000) NOT NULL,
	[LbmbMobilenb] [nvarchar](2000) NOT NULL,
	[Email1] [nvarchar](2000) NOT NULL,
	[ShortName] [nvarchar](2000) NOT NULL,
	[LegalHolderName] [nvarchar](2000) NOT NULL,
	[LegalExpDate] [nvarchar](2000) NOT NULL,
	[GreenCardNo] [nvarchar](2000) NOT NULL,
	[FCntryCode] [nvarchar](2000) NOT NULL,
	[FAreaCode] [nvarchar](2000) NOT NULL,
	[Faxnb] [nvarchar](2000) NOT NULL,
	[SgbSrcWealth] [nvarchar](2000) NOT NULL,
	[StatusId] [int] NOT NULL,
	[CreatedBy] [nvarchar](2000) NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[LastModifiedBy] [nvarchar](2000) NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[ComputedSearchColumn]  AS (lower(concat([GivenNames],' ',[FatherName],' ',[FamilyName],' ',[ArFirstName],' ',[ArFFirstName],' ',[ArLastName]))),
	[BirthRegNo] [nvarchar](2000) NOT NULL,
 CONSTRAINT [PK_t_T24Customer] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF_t_T24Customer_GreenCardNo]  DEFAULT ('') FOR [GreenCardNo]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF__t_T24Cust__SgbSr__082D9F89]  DEFAULT ('') FOR [SgbSrcWealth]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF_t_T24Customer_StatusId]  DEFAULT ((-2)) FOR [StatusId]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF_T24Customer_CreatedBy]  DEFAULT ('AlternaSysUser') FOR [CreatedBy]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF_t_T24Customer_CreatedDate]  DEFAULT (getdate()) FOR [CreatedDate]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF_T24Customer_LastModifiedBy]  DEFAULT ('AlternaSysUser') FOR [LastModifiedBy]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF_T24Customer_LastModifiedDate]  DEFAULT (getdate()) FOR [LastModifiedDate]
GO

ALTER TABLE [dbo].[t_T24Customer] ADD  CONSTRAINT [DF__t_T24Cust__Birth__45F4312A]  DEFAULT ('') FOR [BirthRegNo]
GO


