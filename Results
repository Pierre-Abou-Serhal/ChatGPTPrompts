DECLARE @FileImportId bigint = 6;  -- << set this

WITH audit AS (
    SELECT *
    FROM dbo.t_File_Import_Content_Audit
    WHERE FileImportId = @FileImportId
),
distinct_alt AS (
    SELECT DISTINCT FileImportId, AltAccNbr
    FROM audit
),
-- System proposed = first system-only row
sys_proposed AS (
    SELECT
        FileImportId,
        AltAccNbr,
        AccNbr AS SystemProposedAccNbr,
        ROW_NUMBER() OVER (
            PARTITION BY FileImportId, AltAccNbr
            ORDER BY LastModifiedDate ASC, Id ASC
        ) AS rn
    FROM audit
    WHERE CreatedBy = N'AlternaSysUser'
      AND LastModifiedBy = N'AlternaSysUser'
),
-- Last (current) account number = latest row
last_row AS (
    SELECT
        FileImportId,
        AltAccNbr,
        AccNbr AS LastAccNbr,
        ROW_NUMBER() OVER (
            PARTITION BY FileImportId, AltAccNbr
            ORDER BY LastModifiedDate DESC, Id DESC
        ) AS rn
    FROM audit
),
-- Change detection to find WHO edited AccNbr last time it actually changed
ordered AS (
    SELECT
        FileImportId,
        AltAccNbr,
        AccNbr,
        LastModifiedBy,
        LastModifiedDate,
        ROW_NUMBER() OVER (
            PARTITION BY FileImportId, AltAccNbr
            ORDER BY LastModifiedDate ASC, Id ASC
        ) AS seq,
        LAG(AccNbr) OVER (
            PARTITION BY FileImportId, AltAccNbr
            ORDER BY LastModifiedDate ASC, Id ASC
        ) AS prev_acc
    FROM audit
),
changes AS (
    SELECT
        FileImportId,
        AltAccNbr,
        LastModifiedBy,
        LastModifiedDate,
        seq,
        CASE WHEN prev_acc IS NULL OR AccNbr <> prev_acc THEN 1 ELSE 0 END AS is_change
    FROM ordered
),
-- Latest row where AccNbr actually changed -> who/when did the final change
last_change AS (
    SELECT
        FileImportId,
        AltAccNbr,
        LastModifiedBy AS LastEditedBy,
        LastModifiedDate AS LastEditedDate,
        ROW_NUMBER() OVER (
            PARTITION BY FileImportId, AltAccNbr
            ORDER BY seq DESC
        ) AS rn
    FROM changes
    WHERE is_change = 1
),
-- Who validated the file and when (latest StatusCode = '2')
validated AS (
    SELECT FileImportId, ValidatedBy, ValidatedDate
    FROM (
        SELECT
            Id AS FileImportId,
            LastModifiedBy AS ValidatedBy,
            LastModifiedDate AS ValidatedDate,
            ROW_NUMBER() OVER (
                PARTITION BY Id
                ORDER BY LastModifiedDate DESC, CreatedDate DESC, Id DESC
            ) AS rn
        FROM dbo.t_File_Import
        WHERE StatusCode = N'2'
    ) x
    WHERE rn = 1
)
SELECT
    d.FileImportId,
    d.AltAccNbr                                   AS ReceivedAccountNumber,
    sp.SystemProposedAccNbr,
    lr.LastAccNbr,
    lc.LastEditedBy,
    lc.LastEditedDate,
    v.ValidatedBy,
    v.ValidatedDate,
    c.ProductCode,
    c.CustomerName,
    c.Amount
FROM distinct_alt d
LEFT JOIN sys_proposed sp
    ON sp.FileImportId = d.FileImportId
   AND sp.AltAccNbr    = d.AltAccNbr
   AND sp.rn = 1
LEFT JOIN last_row lr
    ON lr.FileImportId = d.FileImportId
   AND lr.AltAccNbr    = d.AltAccNbr
   AND lr.rn = 1
LEFT JOIN last_change lc
    ON lc.FileImportId = d.FileImportId
   AND lc.AltAccNbr    = d.AltAccNbr
   AND lc.rn = 1
LEFT JOIN dbo.t_File_Import_Content c
    ON c.FileImportId  = d.FileImportId
   AND c.AltAccNbr     = d.AltAccNbr
LEFT JOIN validated v
    ON v.FileImportId  = d.FileImportId
ORDER BY d.AltAccNbr;
