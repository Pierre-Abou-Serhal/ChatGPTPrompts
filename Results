# ============================
# Push all NuGet packages to Azure DevOps Artifacts
# ============================

$nugetExe = "nuget.exe"  # if not in PATH, set full path: "C:\tools\nuget\nuget.exe"
$packagesRoot = "$env:USERPROFILE\Downloads\NugetPackages"
$sourceName = "azure-devops-dev-nuget-offline-packages"
$apiKey = "az" # Azure Artifacts ignores API key content; any string works

if (-not (Get-Command $nugetExe -ErrorAction SilentlyContinue)) {
  throw "nuget.exe not found. Put nuget.exe in PATH or set `$nugetExe to the full path."
}

if (-not (Test-Path $packagesRoot)) {
  throw "Packages folder not found: $packagesRoot"
}

Write-Host "Searching for .nupkg files under: $packagesRoot"

# Get packages (skip symbols by default)
$packages = Get-ChildItem -Path $packagesRoot -Recurse -Filter *.nupkg |
  Where-Object { $_.Name -notlike "*.symbols.nupkg" }

if ($packages.Count -eq 0) {
  Write-Host "No .nupkg files found."
  exit 0
}

Write-Host "Found $($packages.Count) packages. Starting push to source: $sourceName"

$success = 0
$skipped = 0
$failed  = 0

foreach ($pkg in $packages) {
  Write-Host "Pushing: $($pkg.FullName)"
  & $nugetExe push $pkg.FullName `
    -Source $sourceName `
    -ApiKey $apiKey `
    -NonInteractive `
    -SkipDuplicate

  if ($LASTEXITCODE -eq 0) {
    $success++
  } else {
    # With -SkipDuplicate, duplicates usually still exit 0; but just in case:
    $failed++
    Write-Warning "Failed pushing: $($pkg.FullName) (exit code: $LASTEXITCODE)"
  }
}

Write-Host ""
Write-Host "Done."
Write-Host "Success: $success"
Write-Host "Failed : $failed"



nuget.exe sources Add `
  -Name "azure-devops-dev-nuget-offline-packages" `
  -Source "http://uat-azure/DEV/_packaging/azure-devops-dev-nuget-offline-packages/nuget/v3/index.json" `
  -UserName "anything" `
  -Password "<YOUR_PAT>" `
  -StorePasswordInClearText
