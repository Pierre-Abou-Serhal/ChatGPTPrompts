CREATE OR ALTER FUNCTION dbo.ufn_NormalizeName(@s NVARCHAR(4000))
RETURNS NVARCHAR(4000)
AS
BEGIN
    IF @s IS NULL RETURN NULL;

    -- Turn non-breaking spaces into normal spaces
    SET @s = REPLACE(@s, NCHAR(160), N' ');

    -- Trim
    SET @s = LTRIM(RTRIM(@s));

    -- Replace tabs / line breaks with spaces
    SET @s = REPLACE(@s, CHAR(9),  N' ');
    SET @s = REPLACE(@s, CHAR(10), N' ');
    SET @s = REPLACE(@s, CHAR(13), N' ');

    -- Collapse multiple spaces to a single space
    WHILE CHARINDEX(N'  ', @s) > 0
        SET @s = REPLACE(@s, N'  ', N' ');

    -- Optional: unify case (pick one)
    -- SET @s = UPPER(@s);

    RETURN NULLIF(@s, N'');
END
GO
