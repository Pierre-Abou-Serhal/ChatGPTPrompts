CREATE OR ALTER FUNCTION dbo.Fn_NormalizeWord(@s NVARCHAR(4000))
RETURNS NVARCHAR(4000)
WITH SCHEMABINDING, RETURNS NULL ON NULL INPUT
AS
BEGIN
    -- Turn non-breaking spaces into normal spaces
    SET @s = REPLACE(@s, NCHAR(160), N' ');

    -- Trim
    SET @s = LTRIM(RTRIM(@s));

    -- Replace tabs / line breaks with spaces
    SET @s = REPLACE(@s, CHAR(9),  N' ');
    SET @s = REPLACE(@s, CHAR(10), N' ');
    SET @s = REPLACE(@s, CHAR(13), N' ');

    -- Collapse multiple spaces to a single space (loop is OK here since we'll PERSIST)
    WHILE CHARINDEX(N'  ', @s) > 0
        SET @s = REPLACE(@s, N'  ', N' ');

    -- unify case
    SET @s = UPPER(@s);

    RETURN NULLIF(@s, N'');
END
GO


----------------------------------------
----------------------------------------
----------------------------------------

ALTER TABLE dbo.t_T24Customer ADD
  Norm_GivenNames    AS CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(GivenNames), 200)) PERSISTED,
  Norm_FamilyName    AS CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(FamilyName), 200)) PERSISTED,
  Norm_FatherName    AS CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(FatherName), 200)) PERSISTED,
  Norm_MoFirstName   AS CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(MoFirstName), 200)) PERSISTED,
  Norm_DateOfBirth   AS CONVERT(nvarchar(50),  dbo.Fn_NormalizeWord(DateOfBirth)) PERSISTED,
  Norm_BirthRegister AS CONVERT(nvarchar(100), dbo.Fn_NormalizeWord(BirthRegister)) PERSISTED,
  Norm_BirthRegNo    AS CONVERT(nvarchar(100), dbo.Fn_NormalizeWord(BirthRegNo)) PERSISTED,
  Norm_Gender        AS CONVERT(nvarchar(20),  dbo.Fn_NormalizeWord(Gender)) PERSISTED,

  Sdx_GivenNames     AS SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(GivenNames), 200))) PERSISTED,
  Sdx_FamilyName     AS SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(FamilyName), 200))) PERSISTED,
  Sdx_FatherName     AS SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(FatherName), 200))) PERSISTED,
  Sdx_MoFirstName    AS SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(MoFirstName), 200))) PERSISTED;
GO


----------------------------------------
----------------------------------------
----------------------------------------

CREATE INDEX IX_T24Customer_DedupeSeek
ON dbo.t_T24Customer (Sdx_GivenNames, Sdx_FamilyName, Sdx_FatherName, Sdx_MoFirstName, Id)
INCLUDE
(
  Norm_GivenNames, Norm_FamilyName, Norm_FatherName, Norm_MoFirstName,
  Norm_DateOfBirth, Norm_BirthRegister, Norm_BirthRegNo, Norm_Gender
);
GO

CREATE INDEX IX_NewT24Customers_Status
ON dbo.t_NewT24Customers (StatusCode, CustomerId);
GO


----------------------------------------
----------------------------------------
----------------------------------------

CREATE OR ALTER PROCEDURE dbo.usp_Alterna_GetDuplicateCustomers
(
    @MaxCandidatesPerNew   int           = 500,
    @StatusCode            nvarchar(250)  = N'PENDING',
    @DifferenceThreshold   tinyint        = 1  -- 1..4 (higher = stricter)
)
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH NC AS
    (
        SELECT
            T24C.Id AS NewCustomerId,

            -- New customer normalized values (computed once)
            dbo.Fn_NormalizeWord(T24C.DateOfBirth)   AS DateOfBirth,
            dbo.Fn_NormalizeWord(T24C.GivenNames)    AS GivenNames,
            dbo.Fn_NormalizeWord(T24C.FamilyName)    AS FamilyName,
            dbo.Fn_NormalizeWord(T24C.FatherName)    AS FatherName,
            dbo.Fn_NormalizeWord(T24C.MoFirstName)   AS MoFirstName,
            dbo.Fn_NormalizeWord(T24C.BirthRegister) AS BirthRegister,
            dbo.Fn_NormalizeWord(T24C.BirthRegNo)    AS BirthRegNo,
            dbo.Fn_NormalizeWord(T24C.Gender)        AS Gender,

            -- New customer SOUNDEX keys (computed once)
            SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(T24C.GivenNames), 200)))   AS Sdx_GivenNames,
            SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(T24C.FamilyName), 200)))   AS Sdx_FamilyName,
            SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(T24C.FatherName), 200)))   AS Sdx_FatherName,
            SOUNDEX(CONVERT(nvarchar(200), LEFT(dbo.Fn_NormalizeWord(T24C.MoFirstName), 200)))  AS Sdx_MoFirstName
        FROM dbo.t_NewT24Customers AS NT24C
        JOIN dbo.t_T24Customer     AS T24C ON NT24C.CustomerId = T24C.Id
        WHERE NT24C.StatusCode = @StatusCode
    )
    SELECT
        nc.NewCustomerId,
        c.CustomerId,

        -- New customer values
        nc.DateOfBirth   AS New_DateOfBirth,
        nc.GivenNames    AS New_GivenNames,
        nc.FamilyName    AS New_FamilyName,
        nc.FatherName    AS New_FatherName,
        nc.MoFirstName   AS New_MoFirstName,
        nc.BirthRegister AS New_BirthRegister,
        nc.BirthRegNo    AS New_BirthRegNo,
        nc.Gender        AS New_Gender,

        -- Candidate values (from computed columns)
        c.Db_DateOfBirth,
        c.Db_GivenNames,
        c.Db_FamilyName,
        c.Db_FatherName,
        c.Db_MoFirstName,
        c.Db_BirthRegister,
        c.Db_BirthRegNo,
        c.Db_Gender,

        -- Exact flags
        c.Match_DateOfBirth,
        c.Match_BirthRegNo,
        c.Match_BirthRegister,
        c.Match_Gender,

        -- Fuzzy flags
        c.Match_GivenNames,
        c.Match_FamilyName,
        c.Match_FatherName,
        c.Match_MoFirstName
    FROM NC AS nc
    CROSS APPLY
    (
        SELECT TOP (@MaxCandidatesPerNew)
            t.Id AS CustomerId,

            -- Candidate normalized values (already persisted)
            t.Norm_DateOfBirth   AS Db_DateOfBirth,
            t.Norm_GivenNames    AS Db_GivenNames,
            t.Norm_FamilyName    AS Db_FamilyName,
            t.Norm_FatherName    AS Db_FatherName,
            t.Norm_MoFirstName   AS Db_MoFirstName,
            t.Norm_BirthRegister AS Db_BirthRegister,
            t.Norm_BirthRegNo    AS Db_BirthRegNo,
            t.Norm_Gender        AS Db_Gender,

            -- Exact match flags
            CAST(CASE WHEN t.Norm_DateOfBirth   = nc.DateOfBirth   THEN 1 ELSE 0 END AS bit) AS Match_DateOfBirth,
            CAST(CASE WHEN t.Norm_BirthRegNo    = nc.BirthRegNo    THEN 1 ELSE 0 END AS bit) AS Match_BirthRegNo,
            CAST(CASE WHEN t.Norm_BirthRegister = nc.BirthRegister THEN 1 ELSE 0 END AS bit) AS Match_BirthRegister,
            CAST(CASE WHEN t.Norm_Gender        = nc.Gender        THEN 1 ELSE 0 END AS bit) AS Match_Gender,

            -- Fuzzy flags (DIFFERENCE on normalized values)
            CAST(CASE WHEN DIFFERENCE(nc.GivenNames,  t.Norm_GivenNames)  >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_GivenNames,
            CAST(CASE WHEN DIFFERENCE(nc.FamilyName,  t.Norm_FamilyName)  >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_FamilyName,
            CAST(CASE WHEN DIFFERENCE(nc.FatherName,  t.Norm_FatherName)  >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_FatherName,
            CAST(CASE WHEN DIFFERENCE(nc.MoFirstName, t.Norm_MoFirstName) >= @DifferenceThreshold THEN 1 ELSE 0 END AS bit) AS Match_MoFirstName

        FROM dbo.t_T24Customer AS t
        WHERE
            -- avoid matching the same customer
            t.Id <> nc.NewCustomerId

            -- ignore empty/blank names (NormalizeWord returns NULL for blanks)
            AND nc.GivenNames  IS NOT NULL
            AND nc.FamilyName  IS NOT NULL
            AND nc.FatherName  IS NOT NULL
            AND nc.MoFirstName IS NOT NULL

            AND t.Norm_GivenNames  IS NOT NULL
            AND t.Norm_FamilyName  IS NOT NULL
            AND t.Norm_FatherName  IS NOT NULL
            AND t.Norm_MoFirstName IS NOT NULL

            -- FAST prefilter (INDEX SEEK if you created IX_T24Customer_DedupeSeek)
            AND t.Sdx_GivenNames  = nc.Sdx_GivenNames
            AND t.Sdx_FamilyName  = nc.Sdx_FamilyName
            AND t.Sdx_FatherName  = nc.Sdx_FatherName
            AND t.Sdx_MoFirstName = nc.Sdx_MoFirstName

            -- Optional extra narrowing (keeps correctness because only applied when new value exists)
            AND (nc.DateOfBirth IS NULL OR t.Norm_DateOfBirth = nc.DateOfBirth)
            AND (nc.Gender      IS NULL OR t.Norm_Gender      = nc.Gender)
            AND (nc.BirthRegNo  IS NULL OR t.Norm_BirthRegNo  = nc.BirthRegNo)

            -- Expensive checks now run on a small candidate set
            AND DIFFERENCE(nc.GivenNames,  t.Norm_GivenNames)  >= @DifferenceThreshold
            AND DIFFERENCE(nc.FamilyName,  t.Norm_FamilyName)  >= @DifferenceThreshold
            AND DIFFERENCE(nc.FatherName,  t.Norm_FatherName)  >= @DifferenceThreshold
            AND DIFFERENCE(nc.MoFirstName, t.Norm_MoFirstName) >= @DifferenceThreshold

        ORDER BY t.Id
    ) AS c
    ORDER BY nc.NewCustomerId, c.CustomerId
    OPTION (RECOMPILE);
END
GO
