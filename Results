CREATE OR ALTER PROCEDURE [dbo].[usp_Alterna_GetCustomDuplicateCustomer]
(
    @CustomerId     INT, -- Candidate (existing)
    @NewCustomerId  INT  -- New (the one we compare against)
)
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH nc AS
    (
        SELECT
            t.Id AS NewCustomerId,

            dbo.Fn_NormalizeWord(t.DateOfBirth)   AS DateOfBirth,
            dbo.Fn_NormalizeWord(t.GivenNames)    AS GivenNames,
            dbo.Fn_NormalizeWord(t.FamilyName)    AS FamilyName,
            dbo.Fn_NormalizeWord(t.FatherName)    AS FatherName,
            dbo.Fn_NormalizeWord(t.MoFirstName)   AS MoFirstName,
            dbo.Fn_NormalizeWord(t.BirthRegister) AS BirthRegisterId,
            dbo.Fn_NormalizeWord(t.BirthRegNo)    AS BirthRegNo,
            dbo.Fn_NormalizeWord(t.Gender)        AS Gender
        FROM dbo.t_T24Customer t
        WHERE t.Id = @NewCustomerId
    ),
    c AS
    (
        SELECT
            t.Id AS CustomerId,

            -- Candidate normalized values (already persisted)
            t.Norm_DateOfBirth   AS Db_DateOfBirth,
            t.Norm_GivenNames    AS Db_GivenNames,
            t.Norm_FamilyName    AS Db_FamilyName,
            t.Norm_FatherName    AS Db_FatherName,
            t.Norm_MoFirstName   AS Db_MoFirstName,

            t.Norm_BirthRegister AS Db_BirthRegisterId,
            t.Norm_BirthRegNo    AS Db_BirthRegNo,
            t.Norm_Gender        AS Db_Gender
        FROM dbo.t_T24Customer t
        WHERE t.Id = @CustomerId
    )
    SELECT
        nc.NewCustomerId,
        c.CustomerId,

        -- New customer values
        nc.DateOfBirth   AS New_DateOfBirth,
        nc.GivenNames    AS New_GivenNames,
        nc.FamilyName    AS New_FamilyName,
        nc.FatherName    AS New_FatherName,
        nc.MoFirstName   AS New_MoFirstName,

        -- Return description for display (NEW)
        nc.BirthRegisterId           AS New_BirthRegisterId,
        brNew.New_BirthRegisterDesc  AS New_BirthRegister,

        nc.BirthRegNo    AS New_BirthRegNo,
        nc.Gender        AS New_Gender,

        -- Candidate values
        c.Db_DateOfBirth,
        c.Db_GivenNames,
        c.Db_FamilyName,
        c.Db_FatherName,
        c.Db_MoFirstName,

        -- Return description for display (DB)
        c.Db_BirthRegisterId         AS Db_BirthRegisterId,
        brDb.Db_BirthRegisterDesc    AS Db_BirthRegister,

        c.Db_BirthRegNo,
        c.Db_Gender,

        -- Exact flags
        CAST(CASE WHEN c.Db_DateOfBirth      = nc.DateOfBirth      THEN 1 ELSE 0 END AS bit) AS Match_DateOfBirth,
        CAST(CASE WHEN c.Db_BirthRegNo       = nc.BirthRegNo       THEN 1 ELSE 0 END AS bit) AS Match_BirthRegNo,
        CAST(CASE WHEN c.Db_BirthRegisterId  = nc.BirthRegisterId  THEN 1 ELSE 0 END AS bit) AS Match_BirthRegister,
        CAST(CASE WHEN c.Db_Gender           = nc.Gender           THEN 1 ELSE 0 END AS bit) AS Match_Gender,

        -- Fuzzy flags (keep same logic, fixed threshold=4 here)
        CAST(CASE WHEN DIFFERENCE(nc.GivenNames,  c.Db_GivenNames)  >= 4 THEN 1 ELSE 0 END AS bit) AS Match_GivenNames,
        CAST(CASE WHEN DIFFERENCE(nc.FamilyName,  c.Db_FamilyName)  >= 4 THEN 1 ELSE 0 END AS bit) AS Match_FamilyName,
        CAST(CASE WHEN DIFFERENCE(nc.FatherName,  c.Db_FatherName)  >= 4 THEN 1 ELSE 0 END AS bit) AS Match_FatherName,
        CAST(CASE WHEN DIFFERENCE(nc.MoFirstName, c.Db_MoFirstName) >= 4 THEN 1 ELSE 0 END AS bit) AS Match_MoFirstName
    FROM nc
    FULL OUTER JOIN c
        ON 1 = 1

    OUTER APPLY
    (
        SELECT TOP (1) b.DescriptionFR AS New_BirthRegisterDesc
        FROM [Lookup.CusBirth] b
        WHERE b.Id = TRY_CONVERT(int, nc.BirthRegisterId)
    ) brNew

    OUTER APPLY
    (
        SELECT TOP (1) b.DescriptionFR AS Db_BirthRegisterDesc
        FROM [Lookup.CusBirth] b
        WHERE b.Id = TRY_CONVERT(int, c.Db_BirthRegisterId)
    ) brDb;
END
GO
