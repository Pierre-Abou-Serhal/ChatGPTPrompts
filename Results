Great progress — you’ve already solved the hardest parts.

You hit **two on-prem Azure DevOps Server specifics**:

---

## 1) Why `Alterna-DataExport Build Service (DEV)` worked, but `Project Collection Build Service Accounts` didn’t

That’s normal.

Your pipeline is running under the **project-level build identity** for this project (`Alterna-DataExport Build Service (DEV)`), so that’s the identity that needs **ReadPackages** on the feed.

`Project Collection Build Service Accounts` is broader, but depending on your server/feed security setup, it may not be the effective identity used for that pipeline run.

✅ Keep using:

* **`Alterna-DataExport Build Service (DEV)`** with feed read permission.

---

## 2) `PublishPipelineArtifact` is not supported on Azure DevOps Server (on-prem)

Correct — `publish:` in YAML maps to **PublishPipelineArtifact**, and that task is **cloud-only**.

### On Azure DevOps Server, use:

* **`PublishBuildArtifacts@1`** (upload artifact)
* **`DownloadBuildArtifacts@0`** (download artifact in deploy stages)

---

# What you need to change in your YAML

## A) Replace this (cloud-only)

```yml
- publish: '$(Build.ArtifactStagingDirectory)\Alterna-DataExport.zip'
  artifact: drop
```

## With this (on-prem supported)

```yml
- task: PublishBuildArtifacts@1
  displayName: 'Publish Build Artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\Alterna-DataExport.zip'
    ArtifactName: 'drop'
    publishLocation: 'Container'
```

---

## B) Replace this in deploy stage (cloud shortcut)

```yml
- download: current
  artifact: drop
```

## With this (on-prem supported)

```yml
- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Artifact'
  inputs:
    buildType: 'current'
    downloadType: 'single'
    artifactName: 'drop'
    downloadPath: '$(Pipeline.Workspace)'
```

Then your zip will be here:

```yml
$(Pipeline.Workspace)\drop\Alterna-DataExport.zip
```

✅ Which matches your existing `ExtractFiles` path.

---

# Important improvements to your pipeline (recommended)

Your restore worked only after adding `nuget.config`, but your current restore step in the YAML still doesn’t explicitly use it.

## Fix restore to use your `nuget.config`

Change restore step to:

```yml
- task: DotNetCoreCLI@2
  displayName: Restore
  inputs:
    command: restore
    projects: '**/*.csproj'
    feedsToUse: 'config'
    nugetConfigPath: 'nuget.config'
```

> If `nuget.config` is not in repo root, set the correct relative path.

---

## Prevent build/publish from restoring again (and possibly ignoring your config)

Add `--no-restore`:

### Build

```yml
- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: build
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfiguration) --no-restore'
```

### Publish

```yml
- task: DotNetCoreCLI@2
  displayName: Publish
  inputs:
    command: publish
    publishWebProjects: true
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)\publish --no-restore'
    zipAfterPublish: false
```

---

# Your corrected YAML (Build + SIT deploy only, on-prem compatible)

Here’s your pipeline with the **on-prem artifact fix** and **restore fix** applied:

```yml
trigger:
  branches:
    include:
    - sit
    - uat
    - master

variables:
  buildConfiguration: 'Release'

stages:
# =========================
# BUILD
# =========================
- stage: Build
  displayName: Build & Publish Artifact
  jobs:
  - job: BuildJob
    displayName: Build (ASP.NET Core)
    pool:
      name: 'Build Pool'
      demands:
      - Agent.Name -equals 'SIT-ALTERNAB-N1'
    steps:
    - checkout: self
      clean: true

    - task: UseDotNet@2
      displayName: 'Use .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: '**/*.csproj'
        feedsToUse: 'config'
        nugetConfigPath: 'nuget.config'

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)\publish --no-restore'
        zipAfterPublish: false

    - task: ArchiveFiles@2
      displayName: 'Zip publish output'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\publish'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)\Alterna-DataExport.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\Alterna-DataExport.zip'
        ArtifactName: 'drop'
        publishLocation: 'Container'

# =========================
# DEPLOY SIT
# =========================
- stage: Deploy_SIT
  displayName: Deploy to SIT
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/sit'))
  jobs:
  - deployment: DeploySIT
    displayName: 'Deploy SIT (IIS)'
    environment: 'SIT'
    pool:
      name: 'Build Pool'
      demands:
      - Agent.Name -equals 'SIT-ALTERNAB-N1'
    variables:
    - group: 'SIT_VARIABLE_GROUP'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(Pipeline.Workspace)'

          - task: ExtractFiles@1
            displayName: 'Extract artifact'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)\drop\Alterna-DataExport.zip'
              destinationFolder: '$(Pipeline.Workspace)\extracted'
              cleanDestinationFolder: true

          - task: FileTransform@1
            displayName: 'JSON substitution (appsettings.json)'
            inputs:
              folderPath: '$(Pipeline.Workspace)\extracted'
              fileType: 'json'
              targetFiles: '**/appsettings.json'

          - powershell: |
              Import-Module WebAdministration
              Stop-WebAppPool -Name "AlternaDataExportServiceAzureDevOps"
            displayName: 'Stop SIT App Pool'

          - task: CopyFiles@2
            displayName: 'Copy files (SIT)'
            inputs:
              SourceFolder: '$(Pipeline.Workspace)\extracted'
              Contents: '**'
              TargetFolder: 'C:\inetpub\wwwroot\AlternaDataExportService-AzureDevOps-BN1'
              OverWrite: true

          - powershell: |
              Import-Module WebAdministration
              Start-WebAppPool -Name "AlternaDataExportServiceAzureDevOps"
            displayName: 'Start SIT App Pool'
```

---

# One more on-prem note (important)

You’re using the **same agent** (`SIT-ALTERNAB-N1`) for build and deploy right now. That’s okay for a POC, and your YAML is valid for that.

Later, if you split build/deploy agents, just change:

* Build stage pool/demands → your build agent
* Deploy stage pool/demands → your SIT IIS agent

---

If you want, I can now give you the **UAT and PROD sections** in the same corrected on-prem format (with `DownloadBuildArtifacts@0` and environment approvals preserved).
