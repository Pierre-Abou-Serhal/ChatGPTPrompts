@model SGBL.DIGITAL.KYC.Models.ViewModels.CustomerDuplicateDetectionHistoryViewModel
@using SGBL.DIGITAL.KYC.Models;
@using SGBL.DIGITAL.KYC.CrossCutting
@using System
@using System.Linq

@{
    ViewBag.Title = "CustomerDuplicateDetectionHistory";
}

<style>
    .dc-value {
        font-weight: 600;
        line-height: 1.25;
        margin: 0;
        white-space: normal;
        word-break: break-word;
    }

    .dc-meta {
        display: flex;
        flex-wrap: wrap;
        gap: .35rem .5rem;
        align-items: center;
        font-size: .78rem;
        color: #6c757d;
    }

    .dc-pill {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .12rem .5rem;
        border-radius: 999px;
        background: #f6f7f9;
        border: 1px solid #e6e9ee;
        white-space: nowrap;
    }

    .dc-pill b {
        color: #495057;
        font-weight: 600;
    }

    .dc-pill--pct {
        background: #eef6ff;
        border-color: #d7eaff;
    }

    .dc-pct-low {
        background: #fff1f1;
        border-color: #ffd6d6;
        color: #b42318;
    }

    .dc-pct-mid {
        background: #fff7e6;
        border-color: #ffe1b3;
        color: #8a6100;
    }

    .dc-pct-high {
        background: #ecfdf3;
        border-color: #c7f0d8;
        color: #067647;
    }

    .dc-pill--nodup {
        background: #f8f9fa;
        border-color: #e9ecef;
        color: #6c757d;
    }

    /* Make table breathing room */
    #CustomerDuplicateDetectionHistoryDiv th,
    #CustomerDuplicateDetectionHistoryDiv td {
        padding: .75rem .85rem;
        vertical-align: top;
    }

    /* Dual field layout */
    .dc-dual {
        display: flex;
        flex-direction: column;
        gap: .45rem;
        min-width: 220px;
    }

    .dc-dual-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .5rem;
    }

    .dc-dual-row--single {
        grid-template-columns: 1fr;
    }

    .dc-box {
        background: #fff;
        border: 1px solid #e6e9ee;
        border-radius: .6rem;
        padding: .5rem .6rem;
    }

    .dc-label {
        display: block;
        font-size: .68rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: .03em;
        margin-bottom: .2rem;
    }
</style>

@functions {
    string FormatDateString(string date)
    {
        if (string.IsNullOrWhiteSpace(date)) return string.Empty;
        if (date.Length < 8) return date;

        var year = date.Substring(0, 4);
        var month = date.Substring(4, 2);
        var day = date.Substring(6, 2);

        return $"{year}-{month}-{day}";
    }

    decimal CalcPct(decimal mark, decimal total)
        => total == 0 ? 0 : Math.Round((mark / total) * 100m, 2);

    string PctClass(decimal pct)
    {
        if (pct < 50) return "dc-pct-low";
        if (pct < 80) return "dc-pct-mid";
        return "dc-pct-high";
    }
}

@helper GradeMeta(decimal mark, decimal total)
{
    var pct = CalcPct(mark, total);

    <div class="dc-meta">
        <span class="dc-pill">
            <b>Grade</b>
            <span>@Math.Round(mark, 2) / @Math.Round(total, 2)</span>
        </span>

        <span class="dc-pill dc-pill--pct @PctClass(pct)">
            <b>%</b>
            <span>@pct</span>
        </span>
    </div>
}

@helper NoDuplicateMeta()
{
    <div class="dc-meta">
        <span class="dc-pill dc-pill--nodup">
            <b>Status</b>
            <span>No duplicate detected</span>
        </span>
    </div>
}

<div class="app-content content container center-layout">
    <div class="content-wrapper">
        <div class="content-header row">
            <div class="content-header-left col-md-10 col-12 mb-2">
                <h3 class="content-header-title mb-0">CUSTOMER DUPLICATES HISTORY</h3>
                <div class="row breadcrumbs-top">
                    <div class="breadcrumb-wrapper col-12">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/Customer/CustomerDashboard">DASHBOARD</a></li>
                            <li class="breadcrumb-item">History</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="content-header-right col-md-2 col-12 mb-2" style="text-align:end; font-size:larger">
            </div>
        </div>

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/Customer/CustomerDuplicateDetection/">Detect</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/Customer/CustomerDuplicateDetectionHistory/">History</a>
            </li>
        </ul>

        <div class="content-body">
            <section class="users-info">
                <div class="card">

                    <div id="CardTitle" class="card-header bg-secondary text-white text-bold-500 font-large-1" style="padding-top:0px;padding-bottom:0px;">
                        <i id="CardIcon" class="fa fa-info-circle mr-1" aria-hidden="true"></i> Customer Duplicate Detection History
                    </div>

                    <div class="card-content p-2">
                        <div class="card-body">
                            <div id="CustomerDuplicateDetectionHistoryInfo">

                                <div id="CustomDataTableButtonsWrapper">
                                    <div class="row">
                                        <div class="col">
                                            <div class="float-right">
                                                <div id="CustomDataTableButtons"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bold-underline-title mb-2">New Customers</div>

                                @{
                                    // Optional: show a global message if none of the rows has a duplicate
                                    var anyDuplicate = (Model?.DuplicateCustomers ?? Enumerable.Empty<DuplicateCustomerHistoryDto>())
                                        .Any(x => Convert.ToInt32(x.CustomerId) > 0);
                                }

                                @if (!anyDuplicate && (Model?.DuplicateCustomers?.Any() ?? false))
                                {
                                    <div class="alert alert-info">
                                        No duplicate detection found for the listed customers.
                                    </div>
                                }

                                <table id="CustomerDuplicateDetectionHistoryDiv" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Customer ID</th>
                                            <th>First Name</th>
                                            <th>Family Name</th>
                                            <th>Father Name</th>
                                            <th>Mother Name</th>
                                            <th>Date Of Birth</th>
                                            <th>Gender</th>
                                            <th>Register Place</th>
                                            <th>Register Number</th>
                                            <th>Total Grade</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @foreach (DuplicateCustomerHistoryDto customer in Model.DuplicateCustomers)
                                        {
                                            var originalId = Convert.ToInt32(customer.CustomerId); // null -> 0
                                            var hasDuplicate = originalId > 0;

                                            string newCstViewParam = "customerID=" + customer.NewCustomerId + "&tab=tab1";
                                            string originalCstViewParam = "customerID=" + originalId + "&tab=tab1";

                                            decimal totalMarkedGrade =
                                                customer.Mark_GivenNames +
                                                customer.Mark_FamilyName +
                                                customer.Mark_FatherName +
                                                customer.Mark_MoFirstName +
                                                customer.Mark_DateOfBirth +
                                                customer.Mark_Gender +
                                                customer.Mark_BirthRegister +
                                                customer.Mark_BirthRegNo;

                                            decimal totalGrade =
                                                customer.Total_Mark_GivenNames +
                                                customer.Total_Mark_FamilyName +
                                                customer.Total_Mark_FatherName +
                                                customer.Total_Mark_MoFirstName +
                                                customer.Total_Mark_DateOfBirth +
                                                customer.Total_Mark_Gender +
                                                customer.Total_Mark_BirthRegister +
                                                customer.Total_Mark_BirthRegNo;

                                            <tr>
                                                <td style="white-space: nowrap;">
                                                    @if (CustomAuthorizeAttribute.UserHaveAccessToActivity(Constants.KycActivities.ViewCustomer) ||
                                                         CustomAuthorizeAttribute.UserHaveAccessToActivity(Constants.KycActivities.ViewCustomerBranch))
                                                    {
                                                        <a href="/Customer/ViewCustomer/@Global.EncodeParameters(newCstViewParam)"
                                                           title="View New Customer"
                                                           style="color: blue; text-decoration: none; cursor: pointer; font-size: 1.5em;">
                                                            <i class="fa fa-eye fa-1x"></i>
                                                        </a>

                                                        @if (hasDuplicate)
                                                        {
                                                            <span>&nbsp;</span>
                                                            <a href="/Customer/ViewCustomer/@Global.EncodeParameters(originalCstViewParam)"
                                                               title="View Original Customer"
                                                               style="color: #495057; text-decoration: none; cursor: pointer; font-size: 1.5em;">
                                                                <i class="fa fa-eye fa-1x"></i>
                                                            </a>
                                                        }
                                                    }
                                                </td>

                                                <!-- Customer IDs -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.NewCustomerId</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@originalId</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (!hasDuplicate) { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- First Name -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_GivenNames</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_GivenNames</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_GivenNames, customer.Total_Mark_GivenNames) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Family Name -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_FamilyName</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_FamilyName</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_FamilyName, customer.Total_Mark_FamilyName) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Father Name -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_FatherName</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_FatherName</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_FatherName, customer.Total_Mark_FatherName) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Mother Name -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_MoFirstName</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_MoFirstName</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_MoFirstName, customer.Total_Mark_MoFirstName) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- DOB -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@FormatDateString(customer.New_DateOfBirth)</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@FormatDateString(customer.Db_DateOfBirth)</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_DateOfBirth, customer.Total_Mark_DateOfBirth) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Gender -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_Gender</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_Gender</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_Gender, customer.Total_Mark_Gender) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Register Place -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_BirthRegister</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_BirthRegister</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_BirthRegister, customer.Total_Mark_BirthRegister) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Register Number -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-dual-row @(hasDuplicate ? "" : "dc-dual-row--single")">
                                                            <div class="dc-box">
                                                                <span class="dc-label">New</span>
                                                                <div class="dc-value">@customer.New_BirthRegNo</div>
                                                            </div>

                                                            @if (hasDuplicate)
                                                            {
                                                                <div class="dc-box">
                                                                    <span class="dc-label">Original</span>
                                                                    <div class="dc-value">@customer.Db_BirthRegNo</div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(customer.Mark_BirthRegNo, customer.Total_Mark_BirthRegNo) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>

                                                <!-- Total Grade -->
                                                <td>
                                                    <div class="dc-dual">
                                                        <div class="dc-box">
                                                            <span class="dc-label">Total</span>
                                                            <div class="dc-value">
                                                                @if (hasDuplicate)
                                                                {
                                                                    @Math.Round(totalMarkedGrade, 2) <text> / </text> @Math.Round(totalGrade, 2)
                                                                }
                                                                else
                                                                {
                                                                    <text>N/A</text>
                                                                }
                                                            </div>
                                                        </div>

                                                        @if (hasDuplicate) { @GradeMeta(totalMarkedGrade, totalGrade) }
                                                        else { @NoDuplicateMeta() }
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                @if (!(Model?.DuplicateCustomers?.Any() ?? false))
                                {
                                    <div class="alert alert-warning mt-2">
                                        No records found.
                                    </div>
                                }

                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            HideLoader();

            $('#CustomerDuplicateDetectionHistoryDiv').DataTable({
                scrollX: true,
                autoWidth: false,
                pageLength: 25,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                fixedHeader: true,
                columnDefs: [
                    { targets: 0, orderable: false, width: "70px" }
                ]
            });
        });
    </script>
}
