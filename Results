Yep — this is just because `Stop-WebAppPool` throws an error if it’s **already stopped**.

So your script is fine logically, but you need to make it **idempotent** (safe to run multiple times).

## Fix

Before stopping the app pool, check its state (same as you did for the website).

### Replace your stop step with this

```yml
- powershell: |
    Import-Module WebAdministration

    $siteName = "AlternaDataExportServiceAzureDevOps"
    $appPool  = "AlternaDataExportServiceAzureDevOps"

    # Stop website only if running
    $site = Get-Website -Name $siteName
    Write-Host "Website current state: $($site.State)"
    if ($site.State -ne "Stopped") {
      Write-Host "Stopping website: $siteName"
      Stop-Website -Name $siteName
    } else {
      Write-Host "Website already stopped."
    }

    # Stop app pool only if running
    $poolState = (Get-WebAppPoolState -Name $appPool).Value
    Write-Host "AppPool current state: $poolState"
    if ($poolState -ne "Stopped") {
      Write-Host "Stopping app pool: $appPool"
      Stop-WebAppPool -Name $appPool
    } else {
      Write-Host "AppPool already stopped."
    }

    # Wait until both are stopped
    $maxTries = 30
    for ($i = 1; $i -le $maxTries; $i++) {
      $siteState = (Get-Website -Name $siteName).State
      $poolState = (Get-WebAppPoolState -Name $appPool).Value

      Write-Host "Website state: $siteState | AppPool state: $poolState"

      if ($siteState -eq "Stopped" -and $poolState -eq "Stopped") {
        Write-Host "Website and App Pool are stopped."
        break
      }

      Start-Sleep -Seconds 2
    }

    $finalSiteState = (Get-Website -Name $siteName).State
    $finalPoolState = (Get-WebAppPoolState -Name $appPool).Value

    if ($finalSiteState -ne "Stopped" -or $finalPoolState -ne "Stopped") {
      throw "Failed to stop Website/AppPool. Final states => Website: $finalSiteState | AppPool: $finalPoolState"
    }

    Start-Sleep -Seconds 2
  displayName: 'Stop SIT Website + App Pool'
```

---

## Optional improvement for the start step too

`Start-WebAppPool` / `Start-Website` can also complain if already started (less common, but can happen).
You can make it idempotent too:

```yml
- powershell: |
    Import-Module WebAdministration

    $siteName = "AlternaDataExportServiceAzureDevOps"
    $appPool  = "AlternaDataExportServiceAzureDevOps"

    $poolState = (Get-WebAppPoolState -Name $appPool).Value
    if ($poolState -ne "Started") {
      Write-Host "Starting app pool: $appPool"
      Start-WebAppPool -Name $appPool
    } else {
      Write-Host "AppPool already started."
    }

    $siteState = (Get-Website -Name $siteName).State
    if ($siteState -ne "Started") {
      Write-Host "Starting website: $siteName"
      Start-Website -Name $siteName
    } else {
      Write-Host "Website already started."
    }

    $siteState = (Get-Website -Name $siteName).State
    $poolState = (Get-WebAppPoolState -Name $appPool).Value
    Write-Host "Website state: $siteState | AppPool state: $poolState"
  displayName: 'Start SIT Website + App Pool'
```

---

## Why it happened on second run

On the first run, the app pool got stopped.
Then the pipeline failed later (or didn’t start it back), so when you ran again, it was already stopped.

This updated script handles that cleanly.
