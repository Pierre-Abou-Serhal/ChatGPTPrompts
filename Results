parameters:
- name: deploymentName
  type: string
  default: 'DeployJob'

- name: deploymentDisplayName
  type: string
  default: 'Deploy IIS'

- name: environmentName
  type: string

- name: deployPool
  type: string

- name: deployAgentName
  type: string

- name: variableGroup
  type: string

- name: zipName
  type: string

- name: siteName
  type: string

- name: appPoolName
  type: string

- name: iisTargetPath
  type: string

- name: appSettingsFilePattern
  type: string
  default: '**/appsettings.json'

jobs:
- deployment: ${{ parameters.deploymentName }}
  displayName: ${{ parameters.deploymentDisplayName }}

  environment: ${{ parameters.environmentName }}

  pool:
    name: ${{ parameters.deployPool }}
    demands:
    - Agent.Name -equals ${{ parameters.deployAgentName }}

  variables:
  - group: ${{ parameters.variableGroup }}

  strategy:
    runOnce:
      deploy:
        steps:
        - task: DownloadBuildArtifacts@0
          displayName: 'Download Build Artifact'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'drop'
            downloadPath: '$(Pipeline.Workspace)'

        - task: ExtractFiles@1
          displayName: 'Extract artifact'
          inputs:
            archiveFilePatterns: '$(Pipeline.Workspace)\drop\${{ parameters.zipName }}'
            destinationFolder: '$(Pipeline.Workspace)\extracted'
            cleanDestinationFolder: true

        - task: FileTransform@1
          displayName: 'JSON substitution (appsettings.json)'
          inputs:
            folderPath: '$(Pipeline.Workspace)\extracted'
            fileType: 'json'
            targetFiles: ${{ parameters.appSettingsFilePattern }}

        # Stop website + app pool safely (idempotent)
        - powershell: |
            Import-Module WebAdministration

            $siteName = "${{ parameters.siteName }}"
            $appPool  = "${{ parameters.appPoolName }}"

            $site = Get-Website -Name $siteName
            Write-Host "Website current state: $($site.State)"
            if ($site.State -ne "Stopped") {
              Write-Host "Stopping website: $siteName"
              Stop-Website -Name $siteName
            } else {
              Write-Host "Website already stopped."
            }

            $poolState = (Get-WebAppPoolState -Name $appPool).Value
            Write-Host "AppPool current state: $poolState"
            if ($poolState -ne "Stopped") {
              Write-Host "Stopping app pool: $appPool"
              Stop-WebAppPool -Name $appPool
            } else {
              Write-Host "AppPool already stopped."
            }

            $maxTries = 30
            for ($i = 1; $i -le $maxTries; $i++) {
              $siteState = (Get-Website -Name $siteName).State
              $poolState = (Get-WebAppPoolState -Name $appPool).Value

              Write-Host "Website state: $siteState | AppPool state: $poolState"

              if ($siteState -eq "Stopped" -and $poolState -eq "Stopped") {
                Write-Host "Website and App Pool are stopped."
                break
              }

              Start-Sleep -Seconds 2
            }

            $finalSiteState = (Get-Website -Name $siteName).State
            $finalPoolState = (Get-WebAppPoolState -Name $appPool).Value

            if ($finalSiteState -ne "Stopped" -or $finalPoolState -ne "Stopped") {
              throw "Failed to stop Website/AppPool. Final states => Website: $finalSiteState | AppPool: $finalPoolState"
            }

            Start-Sleep -Seconds 2
          displayName: 'Stop Website + App Pool'

        - task: CopyFiles@2
          displayName: 'Copy files'
          inputs:
            SourceFolder: '$(Pipeline.Workspace)\extracted'
            Contents: '**'
            TargetFolder: '${{ parameters.iisTargetPath }}'
            OverWrite: true

        # Start website + app pool safely (idempotent)
        - powershell: |
            Import-Module WebAdministration

            $siteName = "${{ parameters.siteName }}"
            $appPool  = "${{ parameters.appPoolName }}"

            $poolState = (Get-WebAppPoolState -Name $appPool).Value
            if ($poolState -ne "Started") {
              Write-Host "Starting app pool: $appPool"
              Start-WebAppPool -Name $appPool
            } else {
              Write-Host "AppPool already started."
            }

            $siteState = (Get-Website -Name $siteName).State
            if ($siteState -ne "Started") {
              Write-Host "Starting website: $siteName"
              Start-Website -Name $siteName
            } else {
              Write-Host "Website already started."
            }

            $siteState = (Get-Website -Name $siteName).State
            $poolState = (Get-WebAppPoolState -Name $appPool).Value
            Write-Host "Website state: $siteState | AppPool state: $poolState"
          displayName: 'Start Website + App Pool'
