Starting: Stop SIT Website + App Pool
==============================================================================
Task         : PowerShell
Description  : Run a PowerShell script on Linux, macOS, or Windows
Version      : 2.232.0
Author       : Microsoft Corporation
Help         : https://docs.microsoft.com/azure/devops/pipelines/tasks/utility/powershell
==============================================================================
Generating script.
========================== Starting Command Output ===========================
"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -NoLogo -NoProfile -NonInteractive -ExecutionPolicy Unrestricted -Command ". 'C:\agent\_work\_temp\54d3af5b-7bc7-4ce7-8cf8-8d91176edc62.ps1'"
Stopping website: AlternaDataExportServiceAzureDevOps
Stopping app pool: AlternaDataExportServiceAzureDevOps
stop-webitem : Object on target path is already stopped.
At C:\agent\_work\_temp\54d3af5b-7bc7-4ce7-8cf8-8d91176edc62.ps1:15 char:1
+ Stop-WebAppPool -Name $appPool
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [Stop-WebItem], InvalidOpe 
   rationException
    + FullyQualifiedErrorId : InvalidOperation,Microsoft.IIs.PowerShell.Provid 
   er.StopItemCommand
 
##[error]PowerShell exited with code '1'.
Finishing: Stop SIT Website + App Pool

This is my pipeline

trigger:
  branches:
    include:
    - sit
    - uat
    - master

variables:
  buildConfiguration: 'Release'

stages:
# =========================
# BUILD (runs for sit/uat/master)
# =========================
- stage: Build
  displayName: Build & Publish Artifact
  jobs:
  - job: BuildJob
    displayName: Build (ASP.NET Core)
    pool:
      name: 'Build Pool'
      demands:
      - Agent.Name -equals UAT-ALTERNA-DK1
    steps:
    - checkout: self
      clean: true

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: '**/*.csproj'
        feedsToUse: 'config'
        nugetConfigPath: 'nuget.config'
 
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)\publish --no-restore'
        zipAfterPublish: false

    - task: ArchiveFiles@2
      displayName: 'Zip publish output'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\publish\Alterna-DataExport'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)\Alterna-DataExport.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\Alterna-DataExport.zip'
        ArtifactName: 'drop'
        publishLocation: 'Container'


# =========================
# DEPLOY SIT
# =========================
- stage: Deploy_SIT
  displayName: Deploy to SIT
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/sit'))
  jobs:
  - deployment: DeploySIT
    displayName: 'Deploy SIT (IIS)'
    environment: 'SIT'
    pool:
      name: 'Build Pool'
      demands:
      - Agent.Name -equals SIT-ALTERNA-BN1
    variables:
    - group: 'SIT_VARIABLE_GROUP'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(Pipeline.Workspace)'

          - task: ExtractFiles@1
            displayName: 'Extract artifact'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)\drop\Alterna-DataExport.zip'
              destinationFolder: '$(Pipeline.Workspace)\extracted'
              cleanDestinationFolder: true

          - task: FileTransform@1
            displayName: 'JSON substitution (appsettings.json)'
            inputs:
              folderPath: '$(Pipeline.Workspace)\extracted'
              fileType: 'json'
              targetFiles: '**/appsettings.json'

          - powershell: |
              Import-Module WebAdministration

              $siteName = "AlternaDataExportServiceAzureDevOps"
              $appPool  = "AlternaDataExportServiceAzureDevOps"

              Write-Host "Stopping website: $siteName"
              if ((Get-Website -Name $siteName).State -ne "Stopped") {
                Stop-Website -Name $siteName
              }

              Write-Host "Stopping app pool: $appPool"
              Stop-WebAppPool -Name $appPool

              $maxTries = 30
              for ($i = 1; $i -le $maxTries; $i++) {
                $siteState = (Get-Website -Name $siteName).State
                $poolState = (Get-WebAppPoolState -Name $appPool).Value

                Write-Host "Website state: $siteState | AppPool state: $poolState"

                if ($siteState -eq "Stopped" -and $poolState -eq "Stopped") {
                  Write-Host "Website and App Pool are stopped."
                  break
                }

                Start-Sleep -Seconds 2
              }

              $finalSiteState = (Get-Website -Name $siteName).State
              $finalPoolState = (Get-WebAppPoolState -Name $appPool).Value

              if ($finalSiteState -ne "Stopped" -or $finalPoolState -ne "Stopped") {
                throw "Failed to stop Website/AppPool. Final states => Website: $finalSiteState | AppPool: $finalPoolState"
              }

              Start-Sleep -Seconds 2
            displayName: 'Stop SIT Website + App Pool'

          - task: CopyFiles@2
            displayName: 'Copy files (SIT)'
            inputs:
              SourceFolder: '$(Pipeline.Workspace)\extracted'
              Contents: '**'
              TargetFolder: 'C:\inetpub\wwwroot\AlternaDataExportService-AzureDevOps-BN1'
              OverWrite: true

          - powershell: |
              Import-Module WebAdministration

              $siteName = "AlternaDataExportServiceAzureDevOps"
              $appPool  = "AlternaDataExportServiceAzureDevOps"

              Write-Host "Starting app pool: $appPool"
              Start-WebAppPool -Name $appPool

              Write-Host "Starting website: $siteName"
              Start-Website -Name $siteName

              $siteState = (Get-Website -Name $siteName).State
              $poolState = (Get-WebAppPoolState -Name $appPool).Value

              Write-Host "Website state: $siteState | AppPool state: $poolState"
            displayName: 'Start SIT Website + App Pool'


# =========================
# DEPLOY UAT (only when branch == uat) - approvals via Environment checks
# =========================
# - stage: Deploy_UAT
#   displayName: Deploy to UAT (Approval required)
#   dependsOn: Build
#   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/uat'))
#   jobs:
#   - deployment: DeployUAT
#     displayName: 'Deploy UAT (IIS)'
#     environment: 'UAT'     # <-- approvals/checks configured in the UAT environment UI
#     pool:
#       name: 'IIS-UAT'
#     variables:
#     - group: 'UAT_VARIABLE_GROUP'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: drop

#           - task: ExtractFiles@1
#             displayName: 'Extract artifact'
#             inputs:
#               archiveFilePatterns: '$(Pipeline.Workspace)\drop\Alterna-DataExport.zip'
#               destinationFolder: '$(Pipeline.Workspace)\extracted'
#               cleanDestinationFolder: true

#           - task: FileTransform@1
#             displayName: 'JSON substitution (appsettings.json)'
#             inputs:
#               folderPath: '$(Pipeline.Workspace)\extracted'
#               fileType: 'json'
#               targetFiles: '**/appsettings.json'

#           - powershell: |
#               Import-Module WebAdministration
#               Stop-WebAppPool -Name "DataExport_UAT_AppPool"
#             displayName: 'Stop UAT App Pool'

#           - task: CopyFiles@2
#             displayName: 'Copy files (UAT)'
#             inputs:
#               SourceFolder: '$(Pipeline.Workspace)\extracted'
#               Contents: '**'
#               TargetFolder: 'C:\inetpub\wwwroot\DataExport'   # <-- UAT path
#               OverWrite: true

#           - powershell: |
#               Import-Module WebAdministration
#               Start-WebAppPool -Name "DataExport_UAT_AppPool"
#             displayName: 'Start UAT App Pool'


# # =========================
# # DEPLOY PROD (only when branch == master) - approvals via Environment checks
# # =========================
# - stage: Deploy_PROD
#   displayName: Deploy to PROD (Approval required)
#   dependsOn: Build
#   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
#   jobs:
#   - deployment: DeployPROD
#     displayName: 'Deploy PROD (IIS)'
#     environment: 'PROD'    # <-- approvals/checks configured in the PROD environment UI
#     pool:
#       name: 'IIS-PROD'     # <-- locked-down pool recommended
#     variables:
#     - group: 'PRD_VARIABLE_GROUP'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: drop

#           - task: ExtractFiles@1
#             displayName: 'Extract artifact'
#             inputs:
#               archiveFilePatterns: '$(Pipeline.Workspace)\drop\Alterna-DataExport.zip'
#               destinationFolder: '$(Pipeline.Workspace)\extracted'
#               cleanDestinationFolder: true

#           - task: FileTransform@1
#             displayName: 'JSON substitution (appsettings.json)'
#             inputs:
#               folderPath: '$(Pipeline.Workspace)\extracted'
#               fileType: 'json'
#               targetFiles: '**/appsettings.json'

#           - powershell: |
#               Import-Module WebAdministration
#               Stop-WebAppPool -Name "DataExport_PROD_AppPool"
#             displayName: 'Stop PROD App Pool'

#           - task: CopyFiles@2
#             displayName: 'Copy files (PROD)'
#             inputs:
#               SourceFolder: '$(Pipeline.Workspace)\extracted'
#               Contents: '**'
#               TargetFolder: 'C:\inetpub\wwwroot\DataExport'   # <-- PROD path
#               OverWrite: true

#           - powershell: |
#               Import-Module WebAdministration
#               Start-WebAppPool -Name "DataExport_PROD_AppPool"
#             displayName: 'Start PROD App Pool'
