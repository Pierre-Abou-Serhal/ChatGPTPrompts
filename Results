parameters:
- name: jobName
  type: string
  default: 'BuildJob'

- name: jobDisplayName
  type: string
  default: 'Build (.NET)'

- name: buildPool
  type: string

- name: buildAgentName
  type: string

- name: buildConfiguration
  type: string
  default: 'Release'

- name: restoreProjects
  type: string
  default: '**/*.csproj'

- name: runTests
  type: boolean
  default: false

- name: testProjects
  type: string
  default: '**/*Tests/*.csproj'

- name: publishProject
  type: string

- name: nugetConfigPath
  type: string
  default: 'nuget.config'

- name: zipName
  type: string
  default: 'WebApp.zip'

- name: publishOutputFolder
  type: string
  default: '$(Build.ArtifactStagingDirectory)\publish'
  
jobs:
- job: ${{ parameters.jobName }}
  displayName: ${{ parameters.jobDisplayName }}

  pool:
    name: ${{ parameters.buildPool }}
    demands:
    - Agent.Name -equals ${{ parameters.buildAgentName }}

  steps:
  - checkout: self
    clean: true

  # Restore using nuget.config
  - task: DotNetCoreCLI@2
    displayName: 'Restore'
    inputs:
      command: 'restore'
      projects: ${{ parameters.restoreProjects }}
      feedsToUse: 'config'
      nugetConfigPath: ${{ parameters.nugetConfigPath }}

  # Building project: dotnet build
  - task: DotNetCoreCLI@2
    displayName: 'Build'
    inputs:
      command: 'build'
      projects: ${{ parameters.restoreProjects }}
      arguments: '--configuration ${{ parameters.buildConfiguration }} --no-restore'

  # Running tests if available: dotnet test
  - task: DotNetCoreCLI@2
    displayName: 'Test'
    condition: and(succeeded(), eq('${{ parameters.runTests }}', 'true'))
    inputs:
      command: 'test'
      projects: ${{ parameters.testProjects }}
      arguments: '--configuration ${{ parameters.buildConfiguration }} --no-build --no-restore'
      publishTestResults: true

  # Publish the API project
  - task: DotNetCoreCLI@2
    displayName: 'Publish'
    inputs:
      command: 'publish'
      projects: ${{ parameters.publishProject }}
      arguments: '--configuration ${{ parameters.buildConfiguration }} --output "${{ parameters.publishOutputFolder }}" --no-restore'
      zipAfterPublish: false
      modifyOutputPath: false

  # Zipping published files
  - task: ArchiveFiles@2
    displayName: 'Zip publish output'
    inputs:
      rootFolderOrFile: '${{ parameters.publishOutputFolder }}'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\${{ parameters.zipName }}'
      replaceExistingArchive: true

  # Uploading zipped files to Azure
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Build Artifact'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\${{ parameters.zipName }}'
      ArtifactName: 'drop'
      publishLocation: 'Container'
