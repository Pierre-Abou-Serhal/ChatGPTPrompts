trigger:
  branches:
    include:
    - sit
    - uat
    - master

variables:
  buildConfiguration: 'Release'

stages:
# =========================
# BUILD (runs for sit/uat/master)
# =========================
- stage: Build
  displayName: Build & Publish Artifact
  jobs:
  - job: BuildJob
    displayName: Build (ASP.NET Core)
    pool:
      name: 'BUILD'   # <-- self-hosted build agent pool
    steps:
    - checkout: self
      clean: true

    - task: UseDotNet@2
      displayName: 'Use .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'   # <-- change to your project's SDK (6.x/7.x/8.x)

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)\publish'
        zipAfterPublish: false

    - task: ArchiveFiles@2
      displayName: 'Zip publish output'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\publish'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)\WebApp.zip'
        replaceExistingArchive: true

    - publish: '$(Build.ArtifactStagingDirectory)\WebApp.zip'
      artifact: drop


# =========================
# DEPLOY SIT (only when branch == sit)
# =========================
- stage: Deploy_SIT
  displayName: Deploy to SIT
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/sit'))
  jobs:
  - deployment: DeploySIT
    displayName: 'Deploy SIT (IIS)'
    environment: 'SIT'     # <-- Azure Environment name
    pool:
      name: 'IIS-SIT'      # <-- agent pool with SIT IIS agent
    variables:
    - group: 'VG-SIT-DataExport'  # <-- your SIT variable group
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: ExtractFiles@1
            displayName: 'Extract artifact'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)\drop\WebApp.zip'
              destinationFolder: '$(Pipeline.Workspace)\extracted'
              cleanDestinationFolder: true

          - task: FileTransform@1
            displayName: 'JSON substitution (appsettings.json)'
            inputs:
              folderPath: '$(Pipeline.Workspace)\extracted'
              fileType: 'json'
              targetFiles: '**/appsettings.json'

          - powershell: |
              Import-Module WebAdministration
              Stop-WebAppPool -Name "DataExport_SIT_AppPool"
            displayName: 'Stop SIT App Pool'

          - task: CopyFiles@2
            displayName: 'Copy files (SIT)'
            inputs:
              SourceFolder: '$(Pipeline.Workspace)\extracted'
              Contents: '**'
              TargetFolder: 'C:\inetpub\wwwroot\DataExport'   # <-- SIT path
              OverWrite: true

          - powershell: |
              Import-Module WebAdministration
              Start-WebAppPool -Name "DataExport_SIT_AppPool"
            displayName: 'Start SIT App Pool'


# =========================
# DEPLOY UAT (only when branch == uat) - approvals via Environment checks
# =========================
- stage: Deploy_UAT
  displayName: Deploy to UAT (Approval required)
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/uat'))
  jobs:
  - deployment: DeployUAT
    displayName: 'Deploy UAT (IIS)'
    environment: 'UAT'     # <-- approvals/checks configured in the UAT environment UI
    pool:
      name: 'IIS-UAT'
    variables:
    - group: 'VG-UAT-DataExport'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: ExtractFiles@1
            displayName: 'Extract artifact'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)\drop\WebApp.zip'
              destinationFolder: '$(Pipeline.Workspace)\extracted'
              cleanDestinationFolder: true

          - task: FileTransform@1
            displayName: 'JSON substitution (appsettings.json)'
            inputs:
              folderPath: '$(Pipeline.Workspace)\extracted'
              fileType: 'json'
              targetFiles: '**/appsettings.json'

          - powershell: |
              Import-Module WebAdministration
              Stop-WebAppPool -Name "DataExport_UAT_AppPool"
            displayName: 'Stop UAT App Pool'

          - task: CopyFiles@2
            displayName: 'Copy files (UAT)'
            inputs:
              SourceFolder: '$(Pipeline.Workspace)\extracted'
              Contents: '**'
              TargetFolder: 'C:\inetpub\wwwroot\DataExport'   # <-- UAT path
              OverWrite: true

          - powershell: |
              Import-Module WebAdministration
              Start-WebAppPool -Name "DataExport_UAT_AppPool"
            displayName: 'Start UAT App Pool'


# =========================
# DEPLOY PROD (only when branch == master) - approvals via Environment checks
# =========================
- stage: Deploy_PROD
  displayName: Deploy to PROD (Approval required)
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - deployment: DeployPROD
    displayName: 'Deploy PROD (IIS)'
    environment: 'PROD'    # <-- approvals/checks configured in the PROD environment UI
    pool:
      name: 'IIS-PROD'     # <-- locked-down pool recommended
    variables:
    - group: 'VG-PROD-DataExport'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: ExtractFiles@1
            displayName: 'Extract artifact'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)\drop\WebApp.zip'
              destinationFolder: '$(Pipeline.Workspace)\extracted'
              cleanDestinationFolder: true

          - task: FileTransform@1
            displayName: 'JSON substitution (appsettings.json)'
            inputs:
              folderPath: '$(Pipeline.Workspace)\extracted'
              fileType: 'json'
              targetFiles: '**/appsettings.json'

          - powershell: |
              Import-Module WebAdministration
              Stop-WebAppPool -Name "DataExport_PROD_AppPool"
            displayName: 'Stop PROD App Pool'

          - task: CopyFiles@2
            displayName: 'Copy files (PROD)'
            inputs:
              SourceFolder: '$(Pipeline.Workspace)\extracted'
              Contents: '**'
              TargetFolder: 'C:\inetpub\wwwroot\DataExport'   # <-- PROD path
              OverWrite: true

          - powershell: |
              Import-Module WebAdministration
              Start-WebAppPool -Name "DataExport_PROD_AppPool"
            displayName: 'Start PROD App Pool'
