-- File Import Content Audit
BEGIN
        WITH audit AS (
                SELECT *
                FROM dbo.t_File_Import_Content_Audit
                WHERE FileImportId = @P__FileImportId
        ),
        -- System proposed = first system-only row per content line
        sys_proposed AS (
                SELECT
                        Id AS FileImportContentId,
                        AccNbr AS SystemProposedAccNbr,
                        ROW_NUMBER() OVER (
                                PARTITION BY Id
                                ORDER BY LastModifiedDate ASC, CreatedDate ASC
                        ) AS rn
                FROM audit
                WHERE CreatedBy      = N'AlternaSysUser'
                  AND LastModifiedBy = N'AlternaSysUser'
        ),
        -- Last (current) account number per content line
        last_row AS (
                SELECT
                        Id AS FileImportContentId,
                        AccNbr AS LastAccNbr,
                        ROW_NUMBER() OVER (
                                PARTITION BY Id
                                ORDER BY LastModifiedDate DESC, CreatedDate DESC
                        ) AS rn
                FROM audit
        ),
        -- Change detection per content line
        ordered AS (
                SELECT
                        Id AS FileImportContentId,
                        AccNbr,
                        LastModifiedBy,
                        LastModifiedDate,
                        ROW_NUMBER() OVER (
                                PARTITION BY Id
                                ORDER BY LastModifiedDate ASC, CreatedDate ASC
                        ) AS seq,
                        LAG(AccNbr) OVER (
                                PARTITION BY Id
                                ORDER BY LastModifiedDate ASC, CreatedDate ASC
                        ) AS prev_acc
                FROM audit
        ),
        changes AS (
                SELECT
                        FileImportContentId,
                        AccNbr,
                        LastModifiedBy,
                        LastModifiedDate,
                        seq,
                        CASE WHEN prev_acc IS NULL OR AccNbr <> prev_acc THEN 1 ELSE 0 END AS is_change
                FROM ordered
        ),
        -- Latest row where AccNbr actually changed for this line
        last_change AS (
                SELECT
                        FileImportContentId,
                        LastModifiedBy AS LastEditedBy,
                        LastModifiedDate AS LastEditedDate,
                        ROW_NUMBER() OVER (
                                PARTITION BY FileImportContentId
                                ORDER BY seq DESC
                        ) AS rn
                FROM changes
                WHERE is_change = 1
        ),
        -- Who validated the file and when (latest StatusCode = '2')
        validated AS (
                SELECT FileImportId, ValidatedBy, ValidatedDate
                FROM (
                        SELECT
                                Id AS FileImportId,
                                LastModifiedBy AS ValidatedBy,
                                LastModifiedDate AS ValidatedDate,
                                ROW_NUMBER() OVER (
                                        PARTITION BY Id
                                        ORDER BY LastModifiedDate DESC, CreatedDate DESC, Id DESC
                                ) AS rn
                        FROM dbo.t_File_Import_Audit
                        WHERE StatusCode = N'2'
                ) x
                WHERE rn = 1
        )
        SELECT
                c.FileImportId,
                c.Id          AS FileImportContentId,
                c.AltAccNbr   AS ReceivedAccountNumber,
                sp.SystemProposedAccNbr,
                lr.LastAccNbr,
                lc.LastEditedBy,
                lc.LastEditedDate,
                v.ValidatedBy,
                v.ValidatedDate,
                c.ProductCode,
                c.CustomerName,
                c.Amount
        FROM dbo.t_File_Import_Content c
        LEFT JOIN sys_proposed sp
                ON sp.FileImportContentId = c.Id
               AND sp.rn = 1
        LEFT JOIN last_row lr
                ON lr.FileImportContentId = c.Id
               AND lr.rn = 1
        LEFT JOIN last_change lc
                ON lc.FileImportContentId = c.Id
               AND lc.rn = 1
        LEFT JOIN validated v
                ON v.FileImportId = c.FileImportId
        WHERE c.FileImportId = @P__FileImportId
        ORDER BY c.AltAccNbr, c.Id;
END;